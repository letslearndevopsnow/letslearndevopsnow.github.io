---
layout:     post
title:      "Deployment Pipeline On GKE With Cloud Build And GCR"
subtitle:   "Setup A Deployment Pipeline On GKE With Cloud Build And Container Registry"
date:       2021-07-16 18:00:00
author:     "Thaung Htike Oo"
header-img: img/black.jpg
catalog: true
tags:
    - GKE
    - GCP
    - CICD
---    

<h2> Introduction </h2>

ကျွန်တော်ဒီနေ့မှာတော့ docker image တွေကို google cloud ပေါ်က container registry ထဲကို cloud build နဲ့ CI CD pipeline တစ်ခုဆောက်ပြီး gke ပေါ်ကို deployment တစ်ခုစမ်းပြမှာဖြစ်ပါတယ်။ ကျွန်တော့်ရဲ့ code တွေကိုတော့ github ထဲမှာထည့်ထားပြီး python flask app တစ်ခု ရေးထားပါတယ်။  main branch က push မယ့် docker image ကို နာမည်က catgif ၊ tag u က main အဖြစ်ပေးမယ်။ ပြီးတဲ့အခါ gke ပေါ်မှာ deployment အဖြစ် run ပါမယ်။

sample application က အောက်ကပုံအတိုင်း cat gif by main branch ဆိုပြီးဖြစ်တယ်။

![main](https://raw.githubusercontent.com/thaunggyee/thaunggyee.github.io/master/img/main.png)

<h2> GCP Cloud Build </h2>

ပထမဆုံးအနေနဲ့ CI နဲ့ docker image ကို build ဖို့အတွက် trigger တစ်ခုဆောက်ပေးရပါမယ်။ ဒါဆို main branch အတွက် အောက်ကအတိုင်း trigger တစ်ခုဆောက်လိုက်ပါမယ်။ trigger event မှာ push to a branch ကိုရွေးပါမယ်။ အောက်က source မှာ သတ်မှတ်ပေးမယ့် branch ကို commit တစ်ခုလာတိုင်း build ပြီး docker image ထုတ်ပေးမှာပါ။ source မှာကျွန်တော့်ရဲ့ github က code repo ကိုထည့်ပါမယ်။ branch ကတော့ main ပါ။

![t1](https://raw.githubusercontent.com/thaunggyee/thaunggyee.github.io/master/img/t2.png)
 
configuration မှာတော့ Dockerfile ကို create မှာဖြစ်လို့ dockerfile ကို select လုပ်ခဲ့ပြီး directory က / ဖြစ်ပါတယ်။ image name ကိုလည်း catgif ပေးခဲ့ပြီး tag က BRANCH_NAME ဆိုတော့ main ကိုဆိုလိုခြင်းဖြစ်တယ်။ ပြီးသွားရင်တော့ create ကိုနှိပ်လိုက်ပါ။

![t2](https://raw.githubusercontent.com/thaunggyee/thaunggyee.github.io/master/img/t2.png)

create ပြီးသွားတဲ့အခါ run trigger ကို click ပေးပါ။ ခဏကြာတော့ ဒုတိယပုံထဲကလို trigger တစ်ခု build နေတာကို တွေ့ရမှာဖြစ်ပါတယ်။

![runt](https://raw.githubusercontent.com/thaunggyee/thaunggyee.github.io/master/img/runt.png)

ခဏကြာတော့ အောက်ကပုံထဲကလို trigger တစ်ခု build နေတာကို တွေ့ရမှာဖြစ်ပါတယ်။

![buildt](https://raw.githubusercontent.com/thaunggyee/thaunggyee.github.io/master/img/buildt.png)

build တာပြီးသွားတဲ့အခါမှာတော့ container registry ထဲမှာ catgif ဆိုပြီး image တစ်ခုကိုတွေ့ရမှာဖြစ်ပါတယ်။

![catgif](https://raw.githubusercontent.com/thaunggyee/thaunggyee.github.io/master/img/catgif.png)
