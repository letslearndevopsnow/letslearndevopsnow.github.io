---
layout:     post
title:      "Continuous Deployment To GKE With Cloud Build"
subtitle:   "Setup A Deployment Pipeline To GKE With Coud Build And GCR"
date:       2021-07-16 18:00:00
author:     "Thaung Htike Oo"
header-img: img/black.jpg
catalog: true
tags:
    - Kubernetes
    - GKE
    - CICD
---    

<h2> Introduction </h2>

ကျွန်တော်ဒီနေ့ရေးမှာကတော့ gke cluster တစ်ခုပေါ်ကို cloud build နဲ့ continuous deployment လုပ်တဲ့အကြောင်းပဲဖြစ်ပါတယ်။ ဒီ topic ကကျွန်တော်မနေ့ကမှဖတ်ထားးတာဖြစ်ပါတယ်။ နားလည်သလောက်လေးပြန်ရေးလိုက်တာပါ။ cloud build ဆိုတာ google cloud ရဲ့ ci cd tool တစ်ခုဖြစ်ပါတယ်။ cloud build မှာ trigger တွေ create ပြီး ci cd pipeline တွေလုပ်ကြပါတယ်။ ဒီနေ့ lab ရဲ့ သဘောတရားကတော့ github က repo ကို cloud build မှာ trigger ပေးထားမှာဖြစ်ပါတယ်။ main branch နဲ့ တစ်ခြား branch တွေက commit တစ်ခုလာတိုင်း trigger event က continuous deployments steps တွေရေးထားတဲ့ file ကိုသွားအလုပ်လုပ်မှာဖြစ်ပါတယ်။ main branch က လာရင် docker image ကို main tag ပေးပြီး gke ပေါ်မှာ deployment တစ်ခုအဖြစ်သွား run မယ်။ တစ်ခြား branch ကလာရင် docker image ကို branch name ပေးမယ်။ ပြီးရင် gke ပေါ်ကို deployment တစ်ခု run မယ်။ ဒီလောက်ပါပဲ lab ရဲ့သဘောတရားကတော့။ ဒါဆိုအခုပဲ lab ကို စလိုက်ကြရအောင်နော်။

<h2> Create a GKE cluster </h2>

ပထမဆုံးအနေနဲ့ gke cluster တစ်ခုကို create ပေးရပါမယ်။ cloud shell ထဲကို သွားလိုက်ပါ။ cloud shell ထဲကို ရောက်ပြီဆိုလျှင် ကျွန်တော်တို့ လိုအပ်တာတွေစလုပ်လို့ရပါပြီ။ ပထမဆုံး gcloud auth login အရင်လုပ်ပေးရပါမယ်။

```bash
thaunghtikeoo_tho1234@cloudshell:~ (clever-circlet-317905)$ gcloud auth login
Go to the following link in your browser:

    https://accounts.google.com/o/oauth2/auth?response_type=code&client_id=32555940559.apps.googleusercontent.com&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob&scope=openid+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fappengine.admin+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcompute+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Faccounts.reauth&state=wFQ4YUqdUgZxfvYdALW8wSi9GK0Url&prompt=consent&access_type=offline&code_challenge=MThbWkkc2LCeQ9lq4ymjlpbYb03-PPPWCKLXRPpfUjA&code_challenge_method

Enter verification code: <your_code>

You are now logged in as [thaunghtikeoo.tho1234@gmail.com].
Your current project is [clever-circlet-317904].  You can change this setting by running:
  $ gcloud config set project PROJECT_ID
```
login ပြီးတဲ့အခါ လိုအပ်တဲ့ variables တွေသတ်မှတ်ပေးရပါမယ်။

```bash
thaunghtikeoo_tho1234@cloudshell:~ (clever-circlet-317904)$ export PROJECT=$(gcloud info --format='value(config.project)')
thaunghtikeoo_tho1234@cloudshell:~ (clever-circlet-317904)$ export ZONE=us-central1-b
thaunghtikeoo_tho1234@cloudshell:~ (clever-circlet-317904)$ export CLUSTER=gke-deploy-cluster
```
ပြီးသွားရင်တော့ gcloud config ထဲမှာ values တွေထည့်ပေးရပါမယ်။ gke cluster အတွက်သုံးမယ့် cluter name ၊ zone ၊ project_id စသည့် values တွေကိုအောက်ကလိုသတ်မှတ်ပေးရပါမယ်။

```bash
thaunghtikeoo_tho1234@cloudshell:~ (clever-circlet-317904)$ gcloud config set project $PROJECT
Updated property [core/project].
thaunghtikeoo_tho1234@cloudshell:~ (clever-circlet-317904)$ gcloud config set compute/zone $ZONE
Updated property [compute/zone].
thaunghtikeoo_tho1234@cloudshell:~ (clever-circlet-317904)$ gcloud config set container/cluster $CLUSTER
Updated property [container/cluster].
thaunghtikeoo_tho1234@cloudshell:~ (clever-circlet-317904)$
```
ပြီးသွားရင်တော့ console ကနေ အောက်ပါ services တွေအတွက် api တွေကို access ရဖို့လုပ်ပေးရပါမယ်။

```bash
gcloud services enable container.googleapis.com \
    containerregistry.googleapis.com \
    cloudbuild.googleapis.com \
    sourcerepo.googleapis.com
```    
အပေါ်က steps တွေအကုန်ပြီးရင်တော့ gke cluster တစ်ခုကို create ပါမယ်။ အပေါ်မှာ သတ်မှတ်ခဲ့တဲ့ variables တွေကိုပြန်သုံးထားပါတယ်။

```bash
gcloud container clusters create ${CLUSTER} \
    --project=${PROJECT} \
    --zone=${ZONE} \
    --scopes "https://www.googleapis.com/auth/projecthosting,storage-rw"
 ```
 ပြီးသွားရင်တော့ cluster ကို access လုပ်ဖို့ credentials ကိုယူရပါမယ်။ 
 
 ```bash
 thaunghtikeoo_tho1234@cloudshell:~ (clever-circlet-317904)$ gcloud container clusters get-credentials $CLUSTER --zone $ZONE
Fetching cluster endpoint and auth data.
kubeconfig entry generated for gke-deploy-cluster.
```
kubeconfig file ရပြီဆိုတော့ cluster ထဲကို access ရပါပြီ။

```bash
thaunghtikeoo_tho1234@cloudshell:~ (clever-circlet-317904)$ kubectl get nodes
NAME                                                STATUS   ROLES    AGE     VERSION
gke-gke-deploy-cluster-default-pool-3b77fbf9-530t   Ready    <none>   5m59s   v1.19.9-gke.1900
gke-gke-deploy-cluster-default-pool-3b77fbf9-cqv4   Ready    <none>   6m      v1.19.9-gke.1900
gke-gke-deploy-cluster-default-pool-3b77fbf9-wb40   Ready    <none>   6m      v1.19.9-gke.1900
```
<h2> Sample Web App </h2>

lab မှာသုံးမယ့် app ကတော့ docker curriculum က cat app လေးပဲဖြစ်ပါတယ်။ app ကအောက်ကပုံထဲကလိုဖြစ်ပြီး အပေါ်မှာ branch name ကိုတွေ့ရမှာဖြစ်ပါတယ်။

![main](https://raw.githubusercontent.com/thaunggyee/thaunggyee.github.io/master/img/main.png)


